<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caso Clinico Veterinario: Medicina Ovina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="bg-white rounded-xl shadow-lg w-full max-w-4xl overflow-hidden md:flex">
        
        <div class="bg-gray-800 text-white p-6 md:w-1/4 flex flex-col justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">Caso Clinico</h1>
                <p class="text-gray-400 text-sm">Medicina Ovina</p>
                <div class="mt-8 space-y-4 text-sm font-medium">
                    <div id="step1-nav" class="flex items-center space-x-2 text-white">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-blue-500 text-white">1</span>
                        <span>Presentazione del caso</span>
                    </div>
                    <div id="step2-nav" class="flex items-center space-x-2 text-gray-500">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-600 text-white">2</span>
                        <span>Esame Obiettivo</span>
                    </div>
                    <div id="step3-nav" class="flex items-center space-x-2 text-gray-500">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-600 text-white">3</span>
                        <span>Piani Diagnostici</span>
                    </div>
                    <div id="step4-nav" class="flex items-center space-x-2 text-gray-500">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-600 text-white">4</span>
                        <span>Terapia & Prognosi</span>
                    </div>
                    <div id="step5-nav" class="flex items-center space-x-2 text-gray-500">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-600 text-white">5</span>
                        <span>Riepilogo del caso</span>
                    </div>
                </div>
            </div>
            <div id="loading" class="hidden flex items-center justify-center p-4">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <span class="ml-3 text-gray-400">Caricamento...</span>
            </div>
        </div>

        <div class="md:w-3/4 p-6 md:p-10 flex flex-col justify-between">
            <div id="case-content">
                </div>
            <div class="flex justify-between mt-8 pt-4 border-t border-gray-200">
                <button id="prev-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Indietro</button>
                <button id="next-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Avanti</button>
            </div>

            <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4">
                <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modal-title" class="text-xl font-bold"></h3>
                        <button id="close-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    <p id="modal-body" class="text-gray-600 mb-4"></p>
                    <div class="flex justify-end">
                        <button id="modal-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = document.getElementById('app');
        const caseContent = document.getElementById('case-content');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const loading = document.getElementById('loading');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
        // INSERISCI QUI LA TUA CHIAVE API DI GEMINI
        const apiKey = 'AIzaSyBHOCUN8QGnROL0gA0aXntB2skJpVcNTJw'; // <-- Incolla qui la tua chiave API
        // FINE CHIAVE API

        let currentStep = 1;

        // Funzione per mostrare il modal
        const showModal = (title, message, isError = false) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = message;
            if (isError) {
                modalTitle.classList.add('text-red-600');
            } else {
                modalTitle.classList.remove('text-red-600');
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        // Funzione per nascondere il modal
        const hideModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        closeModalBtn.addEventListener('click', hideModal);
        modalOkBtn.addEventListener('click', hideModal);

        // Funzione per effettuare la chiamata all'API di Gemini
        const callGemini = async (prompt) => {
            loading.classList.remove('hidden');
            try {
                const response = await fetch(API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                    }),
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Nessuna risposta generata.';
                return text;
            } catch (error) {
                console.error('Errore nella chiamata all\'API di Gemini:', error);
                return 'Si è verificato un errore. Riprova più tardi.';
            } finally {
                loading.classList.add('hidden');
            }
        };

        // Funzione per scaricare il riassunto
        const downloadSummary = (content, filename) => {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Contenuto delle diverse fasi del caso
        const caseData = {
            step1: {
                title: 'Presentazione del Caso & Anamnesi',
                content: `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800">Presentazione del Caso: Pecora "Bianca"</h2>
                        <p class="text-gray-700">Una pecora di razza Sarda, di 3 anni, primipara, in lattazione (60 giorni post-parto), allevata in un gregge di 200 capi in provincia di Perugia, si presenta con una storia di **inappetenza, letargia e zoppia marcata all'arto posteriore sinistro** da circa 24 ore. L'allevatore ha notato che una mammella è gonfia e dolente.</p>
                        <h3 class="text-xl font-semibold mt-6">Dati Aggiuntivi:</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-600">
                            <li><strong>Alimentazione:</strong> Pascolo e integrazione con fieno e concentrato.</li>
                            <li><strong>Gestione:</strong> Ricovero notturno in stalla con lettiera permanente.</li>
                            <li><strong>Stato riproduttivo:</strong> Lattazione avanzata, agnello sano.</li>
                            <li><strong>Anamnesi remota:</strong> Nessun problema di salute recente, buone condizioni corporee.</li>
                        </ul>
                        <div class="mt-8">
                            <label for="initial-hypothesis" class="block text-gray-700 font-semibold mb-2">Formulare le diagnosi differenziali più probabili in base all'anamnesi:</label>
                            <textarea id="initial-hypothesis" rows="4" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                `,
                requiredInputId: 'initial-hypothesis'
            },
            step2: {
                title: 'Esame Obiettivo',
                content: `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800">Esame Obiettivo Generale e Speciale</h2>
                        <p class="text-gray-700">Durante l'esame clinico, i seguenti dati sono stati rilevati:</p>
                        <ul class="list-disc list-inside space-y-1 text-gray-600">
                            <li><strong>Temperatura Rettale:</strong> 40.5°C (febbre)</li>
                            <li><strong>Frequenza Cardiaca:</strong> 90 bpm (tachicardia)</li>
                            <li><strong>Frequenza Respiratoria:</strong> 40 rpm (tachipnea)</li>
                            <li><strong>Condizioni generali:</strong> Animale depresso, debole, con mucose iperemiche.</li>
                            <li><strong>Esame dell'arto posteriore sinistro:</strong> Zoppia di 4° grado (non poggia l'arto), articolazioni e zoccolo nella norma.</li>
                            <li><strong>Esame della mammella:</strong> Ghiandola mammaria destra normale. Ghiandola mammaria sinistra **aumentata di volume, calda, tesa e estremamente dolente alla palpazione**. Il latte estratto è acquoso, di colore giallastro e contiene fiocchi.</li>
                        </ul>
                        <div class="mt-8">
                            <label class="block text-gray-700 font-semibold mb-2">Quale patogeno è più frequentemente associato a mastiti gravi e gangrenose nelle pecore?</label>
                            <div class="space-y-2">
                                <label class="block">
                                    <input type="radio" name="eo-hypothesis" value="streptococcus-uberis" class="mr-2"> Streptococcus uberis
                                </label>
                                <label class="block">
                                    <input type="radio" name="eo-hypothesis" value="escherichia-coli" class="mr-2"> Escherichia coli
                                </label>
                                <label class="block">
                                    <input type="radio" name="eo-hypothesis" value="staphylococcus-aureus" class="mr-2"> Staphylococcus aureus
                                </label>
                                <label class="block">
                                    <input type="radio" name="eo-hypothesis" value="mannheimia-haemolytica" class="mr-2"> Mannheimia haemolytica
                                </label>
                            </div>
                        </div>
                    </div>
                `,
                requiredInputId: 'eo-hypothesis',
                correctAnswer: 'staphylococcus-aureus'
            },
            step3: {
                title: 'Piani Diagnostici & Diagnosi',
                content: `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800">Piani Diagnostici & Risultati</h2>
                        <p class="text-gray-700">Considerando la gravità dei segni clinici, è stata raccolta un campione di latte dalla mammella affetta per l'esame batteriologico con antibiogramma. Tuttavia, in attesa dei risultati, è necessaria una diagnosi clinica presuntiva immediata.</p>
                        <h3 class="text-xl font-semibold mt-6">Risultati dell'Esame Clinico:</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-600">
                            <li>L'esame della mammella sinistra mostra aree di colore blu-violaceo e fredde al tatto.</li>
                            <li>La pecora è in evidente stato di shock.</li>
                        </ul>
                        <div class="mt-8">
                            <label class="block text-gray-700 font-semibold mb-2">Qual è la diagnosi definitiva basata su questi dati?</label>
                            <textarea id="final-diagnosis" rows="3" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                `,
                requiredInputId: 'final-diagnosis'
            },
            step4: {
                title: 'Terapia & Prognosi',
                content: `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800">Terapia & Prognosi</h2>
                        <p class="text-gray-700">La diagnosi è **mastite gangrenosa acuta**. Ora è necessario impostare un piano terapeutico urgente, considerando la gravità della situazione. Quale sarebbe il tuo approccio?</p>
                        <div class="mt-4">
                            <label for="therapy-plan" class="block text-gray-700 font-semibold mb-2">Proponi un piano terapeutico urgente:</label>
                            <textarea id="therapy-plan" rows="5" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <button id="show-outcome-btn" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Mostra Esito del Caso</button>
                        <div id="case-outcome" class="hidden mt-6">
                            <h3 class="text-xl font-semibold">Esito del caso:</h3>
                            <p class="text-gray-700 mt-2">Alla pecora è stata somministrata una terapia di supporto intensiva (fluidoterapia endovenosa, antinfiammatori non steroidei) e terapia antibiotica sistemica ad ampio spettro. Nonostante gli sforzi, le condizioni dell'animale sono peggiorate a causa dello shock settico e la pecora è deceduta dopo 36 ore. La prognosi per le mastiti gangrenose acute è spesso **sfavorevole**.</p>
                        </div>
                    </div>
                `
            },
            step5: {
                title: 'Riepilogo del caso & Risorse',
                content: `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-gray-800">Approfondimento e Riepilogo Finale</h2>
                        <p class="text-gray-700">Ora che il caso è stato risolto, puoi approfondire la tua comprensione della patologia e ottenere un riassunto dettagliato.</p>
                        <div class="space-y-4 pt-4 border-t border-gray-200">
                            <h3 class="text-xl font-semibold mb-2 text-gray-800">Approfondimento con Gemini</h3>
                            <button id="generate-dd-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition-colors w-full">✨ Visualizza le Diagnosi Differenziali (DD) del caso ✨</button>
                            <div id="dd-output" class="mt-4 p-4 bg-gray-50 rounded-lg text-gray-700 hidden"></div>
                            <button id="explain-rationale-btn" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg shadow-md hover:bg-purple-700 transition-colors w-full">✨ Spiega il Razionale Diagnostico ✨</button>
                            <div id="rationale-output" class="mt-4 p-4 bg-gray-50 rounded-lg text-gray-700 hidden"></div>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-gray-200">
                            <h3 class="text-xl font-semibold mb-2 text-gray-800">Riepilogo della Patologia</h3>
                            <button id="generate-summary-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors w-full">📝 Genera Riepilogo su Mastite Ovina 📝</button>
                            <div id="summary-output" class="mt-4 p-4 bg-gray-50 rounded-lg text-gray-700 hidden"></div>
                            <button id="download-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors w-full hidden">⬇️ Scarica il riassunto (.txt)</button>
                        </div>
                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <a href="index.html" class="block w-full py-3 px-6 bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300 transition-colors text-center font-semibold">
                                Torna alla pagina principale
                            </a>
                        </div>
                    </div>
                `
            }
        };

        const renderStep = (step) => {
            const data = caseData[`step${step}`];
            if (!data) return;

            // Aggiorna la navigazione
            document.querySelectorAll('[id^="step"]').forEach((el, index) => {
                const navStep = index + 1;
                const circle = el.querySelector('span:first-child');
                const text = el.querySelector('span:last-child');
                if (navStep === step) {
                    el.classList.add('text-white');
                    el.classList.remove('text-gray-500');
                    circle.classList.add('bg-blue-500');
                    circle.classList.remove('bg-gray-600');
                } else if (navStep < step) {
                    el.classList.remove('text-white');
                    el.classList.remove('text-gray-500');
                    el.classList.add('text-green-500');
                    circle.classList.add('bg-green-600');
                    circle.classList.remove('bg-gray-600');
                } else {
                    el.classList.remove('text-white');
                    el.classList.add('text-gray-500');
                    circle.classList.remove('bg-blue-500');
                    circle.classList.add('bg-gray-600');
                }
            });

            caseContent.innerHTML = data.content;
            prevBtn.disabled = step === 1;
            nextBtn.disabled = step === Object.keys(caseData).length;
            if (step === Object.keys(caseData).length) {
                nextBtn.classList.add('hidden');
            } else {
                nextBtn.classList.remove('hidden');
            }

            // Aggiungi event listener per i nuovi pulsanti solo nello step finale
            if (step === 5) {
                const generateDdBtn = document.getElementById('generate-dd-btn');
                const ddOutput = document.getElementById('dd-output');
                if (generateDdBtn) {
                    generateDdBtn.addEventListener('click', async () => {
                        const prompt = `Agisci come un esperto veterinario degli ovini. Fornisci un elenco di 5 diagnosi differenziali per una pecora in lattazione con mastite acuta e grave, febbre e zoppia. Per ogni diagnosi, spiega brevemente perché è una possibilità in questo caso specifico e il meccanismo fisiopatologico dietro ai sintomi. Usa un formato di lista.`;
                        const response = await callGemini(prompt);
                        ddOutput.innerHTML = response.replace(/\n/g, '<br>');
                        ddOutput.classList.remove('hidden');
                    });
                }

                const explainRationaleBtn = document.getElementById('explain-rationale-btn');
                const rationaleOutput = document.getElementById('rationale-output');
                if (explainRationaleBtn) {
                    explainRationaleBtn.addEventListener('click', async () => {
                        const prompt = `Spiega, in circa 100 parole e in modo conciso per uno studente di veterinaria, perché la rapida progressione dei sintomi (febbre, zoppia, necrosi mammaria) e il quadro clinico generale della pecora indicano una mastite gangrenosa acuta come diagnosi più probabile, anche prima dei risultati dell'antibiogramma.`;
                        const response = await callGemini(prompt);
                        rationaleOutput.innerHTML = response.replace(/\n/g, '<br>');
                        rationaleOutput.classList.remove('hidden');
                    });
                }

                const generateSummaryBtn = document.getElementById('generate-summary-btn');
                const summaryOutput = document.getElementById('summary-output');
                const downloadBtn = document.getElementById('download-btn');
                if (generateSummaryBtn) {
                    generateSummaryBtn.addEventListener('click', async () => {
                        const prompt = `Agisci come un esperto veterinario degli ovini. Fornisci un riassunto dettagliato ma conciso sulla mastite gangrenosa acuta nelle pecore, includendo la sua eziologia (i principali patogeni coinvolti come Staphylococcus aureus), la fisiopatologia (il ruolo delle tossine batteriche e l'ischemia tissutale), i segni clinici tipici e le principali opzioni terapeutiche, comprese quelle chirurgiche come la mastectomia. Menziona anche la prognosi. Presenta il tutto in paragrafi separati e chiari.`;
                        const response = await callGemini(prompt);
                        summaryOutput.innerHTML = response.replace(/\n/g, '<br>');
                        summaryOutput.classList.remove('hidden');
                        downloadBtn.classList.remove('hidden');
                    });
                }

                if (downloadBtn) {
                    downloadBtn.addEventListener('click', () => {
                        const summaryText = summaryOutput.innerText;
                        if (summaryText) {
                            downloadSummary(summaryText, 'riassunto_mastite_ovina.txt');
                        }
                    });
                }
            }
            
            // Logica per lo step 4: abilita il pulsante solo dopo che l'utente ha scritto nel campo
            if (step === 4) {
                const therapyPlanTextarea = document.getElementById('therapy-plan');
                const showOutcomeBtn = document.getElementById('show-outcome-btn');
                const caseOutcome = document.getElementById('case-outcome');

                const checkInput = () => {
                    if (therapyPlanTextarea.value.trim() !== '') {
                        showOutcomeBtn.disabled = false;
                    } else {
                        showOutcomeBtn.disabled = true;
                    }
                };

                therapyPlanTextarea.addEventListener('input', checkInput);
                showOutcomeBtn.addEventListener('click', () => {
                    caseOutcome.classList.remove('hidden');
                    showOutcomeBtn.disabled = true;
                });
                checkInput();
            }
        };

        const validateStep = (step) => {
            const data = caseData[`step${step}`];
            if (!data.requiredInputId) return true;

            const inputElement = document.getElementById(data.requiredInputId);
            if (!inputElement) return true;

            if (inputElement.type === 'textarea') {
                return inputElement.value.trim() !== '';
            } else if (inputElement.type === 'radio') {
                const checkedRadio = document.querySelector(`input[name="${data.requiredInputId}"]:checked`);
                return checkedRadio !== null;
            }
            return false;
        };

        const handleNext = () => {
            if (currentStep === 2) {
                const selectedAnswer = document.querySelector('input[name="eo-hypothesis"]:checked')?.value;
                if (selectedAnswer !== caseData.step2.correctAnswer) {
                    showModal('Risposta Sbagliata', 'Hai selezionato il patogeno sbagliato. Rivedi i tuoi appunti sulla mastite ovina e riprova!');
                    return;
                }
            }

            if (validateStep(currentStep)) {
                loading.classList.remove('hidden');
                setTimeout(() => {
                    loading.classList.add('hidden');
                    if (currentStep < Object.keys(caseData).length) {
                        currentStep++;
                        renderStep(currentStep);
                    }
                }, 1000);
            } else {
                showModal('Attenzione!', 'Per favora, compila il campo richiesto prima di procedere.');
            }
        };

        const handlePrev = () => {
            if (currentStep > 1) {
                currentStep--;
                renderStep(currentStep);
            }
        };

        prevBtn.addEventListener('click', handlePrev);
        nextBtn.addEventListener('click', handleNext);

        // Inizializza l'applicazione
        renderStep(currentStep);
    </script>
</body>
</html>
