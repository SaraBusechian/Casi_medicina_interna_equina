<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caso Clinico Interattivo: Cavallo con Colica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/opendyslexic@latest/build/css/opendyslexic.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: font-family 0.3s ease;
        }
        body.font-dyslexic {
            font-family: 'OpenDyslexic', sans-serif;
        }
        .case-section, .quiz-card {
            position: relative;
            background-color: #f9fafb;
            border-left: 4px solid #4f46e5;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
        }
        .quiz-card {
             margin-bottom: 0;
        }
        .hidden-section { display: none; }
        .quiz-option { display: block; width: 100%; text-align: left; padding: 0.75rem 1.25rem; margin-bottom: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #ffffff; transition: all 0.2s ease-in-out; cursor: pointer; }
        .quiz-option:hover:not(:disabled) { border-color: #4f46e5; background-color: #eef2ff; }
        .quiz-option.selected { border-color: #4f46e5; background-color: #e0e7ff; font-weight: 600; }
        .quiz-option:disabled { cursor: not-allowed; }
        .summary-section { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 2rem; margin-top: 3rem; border-radius: 0.5rem; }
        
        .accessibility-controls button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .accessibility-controls button.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .tts-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            width: 24px;
            height: 24px;
        }
        .tts-button svg {
            width: 100%;
            height: 100%;
            fill: #6b7280;
            transition: fill 0.2s;
        }
        .tts-button:hover svg {
            fill: #4f46e5;
        }
        .tts-button.active svg {
            fill: #dc2626; /* Red for stop */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600" data-translate-key="mainTitle">Caso Clinico Veterinario Interattivo</h1>
            <p class="text-lg text-gray-600 mt-2" data-translate-key="mainSubtitle">Risolvi il caso passo dopo passo</p>
        </header>

        <!-- Accessibility Controls -->
        <div class="accessibility-controls flex justify-center items-center flex-wrap gap-4 mb-8 bg-white p-4 rounded-lg shadow">
            <div>
                <span class="font-semibold text-gray-700 mr-2" data-translate-key="readingSettings">Impostazioni di lettura:</span>
                <button id="font-standard-btn" class="active" data-translate-key="fontStandard">Font Standard</button>
                <button id="font-dyslexic-btn" data-translate-key="fontAccessible">Font Accessibile</button>
            </div>
            <div class="border-l-2 border-gray-200 pl-4">
                <span class="font-semibold text-gray-700 mr-2" data-translate-key="language">Lingua:</span>
                <button id="lang-it-btn" class="active">ITA</button>
                <button id="lang-en-btn">ENG</button>
            </div>
        </div>

        <main id="case-container" class="bg-white p-6 sm:p-8 rounded-lg shadow-lg">

            <!-- Sezione 1: Anamnesi (visibile da subito) -->
            <section id="anamnesi" class="case-section">
                <button class="tts-button" aria-label="Leggi ad alta voce">
                    <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                <h2 class="text-2xl font-semibold text-gray-900 mb-4" data-translate-key="anamnesisTitle">1. Anamnesi e Segnalamento</h2>
                <div class="space-y-3 text-gray-700" data-translate-key="anamnesisContent">
                    <p><strong>Paziente:</strong> Cavallo maschio castrone, Sella Italiano, 12 anni.</p>
                    <p><strong>Storia recente:</strong> Il proprietario chiama alle 22:00. Riferisce che il cavallo è in colica da circa un'ora. Mostra dolore acuto: si guarda i fianchi, raspa con gli anteriori e tenta di coricarsi.</p>
                    <p><strong>Gestione:</strong> Il cavallo vive in box e viene allenato due volte a settimana per salto ostacoli. L'alimentazione non è cambiata di recente.</p>
                    <p><strong>Profilassi:</strong> Il proprietario riferisce che il cavallo è regolarmente vaccinato e sottoposto a trattamento per endoparassiti.</p>
                </div>
            </section>
            
            <!-- Sezione 2: Visita Clinica (nascosta) -->
            <section id="visita-clinica" class="case-section hidden-section">
                <button class="tts-button" aria-label="Leggi ad alta voce">
                     <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                <h2 class="text-2xl font-semibold text-gray-900 mb-4" data-translate-key="clinicalExamTitle">2. Esame Clinico</h2>
                 <div class="space-y-2 text-gray-700" data-translate-key="clinicalExamContent">
                    <p>All'arrivo, il cavallo è sudato e ansioso. I parametri clinici sono i seguenti:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>Frequenza Cardiaca (FC):</strong> 80 battiti al minuto (bpm).</li>
                        <li><strong>Frequenza Respiratoria (FR):</strong> 40 atti al minuto (apm).</li>
                        <li><strong>Temperatura Rettale:</strong> 38.2°C.</li>
                        <li><strong>Mucose apparenti:</strong> Congeste, con un alone violaceo sul margine gengivale (toxic line). Tempo di Riempimento Capillare (TRC) > 3 secondi.</li>
                         <li><strong>Motilità intestinale:</strong> Assente su tutti e quattro i quadranti.</li>
                    </ul>
                </div>
            </section>
            
            <!-- Sezione 3: Iter Diagnostico (nascosta) -->
            <section id="iter-diagnostico" class="case-section hidden-section">
                <button class="tts-button" aria-label="Leggi ad alta voce">
                     <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                <h2 class="text-2xl font-semibold text-gray-900 mb-4" data-translate-key="diagnosticProcTitle">3. Procedure Diagnostiche Iniziali</h2>
                <div class="space-y-3 text-gray-700" data-translate-key="diagnosticProcContent">
                    <p>Dato il quadro clinico grave, si procede immediatamente con le manovre diagnostiche e terapeutiche di base.</p>
                    <ul class="list-disc list-inside space-y-1">
                       <li><strong>Sondaggio naso-gastrico:</strong> Si ottiene un reflusso spontaneo di 10 litri di liquido maleodorante e di colore rossastro.</li>
                       <li><strong>Esplorazione rettale:</strong> Si apprezzano anse di piccolo intestino notevolmente distese e edematose ("a salsicciotto") nel quadrante addominale destro.</li>
                        <li><strong>Analgesia:</strong> Si somministra Flunixin Meglumine per via endovenosa. Il dolore si attenua solo parzialmente e per breve tempo.</li>
                    </ul>
                </div>
            </section>

            <!-- Sezione 4: Risultati Test (nascosta) -->
             <section id="risultati-test" class="case-section hidden-section">
                <button class="tts-button" aria-label="Leggi ad alta voce">
                     <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                <h2 class="text-2xl font-semibold text-gray-900 mb-4" data-translate-key="abdominocentesisTitle">4. Paracentesi Addominale</h2>
                <div class="space-y-3 text-gray-700" data-translate-key="abdominocentesisContent">
                     <p>Si esegue un prelievo di liquido peritoneale (abdominocentesi).</p>
                    <p><strong>Risultato:</strong> Il liquido appare torbido e di colore siero-emorragico (rosa-arancio). Le proteine totali sono elevate (4.5 g/dL) e la conta dei leucociti è aumentata.</p>
                </div>
            </section>

            <!-- Contenitore del Quiz -->
            <div id="quiz-container" class="mt-6"></div>

            <!-- Sezione Risultati (nascosta) -->
            <div id="results-section" class="summary-section hidden-section"></div>

            <div id="review-section" class="hidden-section mt-8"></div>

            <!-- Sezione Finale: Diagnosi e Riassunto (nascosta) -->
            <div id="final-summary" class="summary-section hidden-section">
                <!-- Italian -->
                <div lang="it">
                    <h2 class="text-center text-3xl font-bold text-green-600 mb-6">Decisione Presa!</h2>
                    <p class="text-center text-xl mb-4">Azione richiesta: <strong>Referral immediato a una clinica chirurgica</strong></p>
                    <div id="printable-summary-it">
                        <h2 class="text-center text-2xl font-bold text-gray-800 mb-4 mt-6">Scheda Riassuntiva: La Colica Chirurgica del Cavallo</h2>
                        <div class="space-y-4 text-left">
                           <!-- Contenuto IT... -->
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-600">Cos'è?</h3>
                                <p class="text-gray-700">La colica è un termine generico che indica dolore addominale. La distinzione più importante è tra coliche "mediche" (gestibili in campo con farmaci) e coliche "chirurgiche", causate da lesioni come torsioni (volvoli), strangolamenti o dislocazioni che richiedono un intervento chirurgico per essere risolte.</p>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-600">Indicatori per la Chirurgia</h3>
                                <p class="text-gray-700">La decisione di inviare un cavallo in clinica si basa sulla combinazione di più fattori. Nessun singolo parametro è definitivo, ma la presenza di più indicatori aumenta la probabilità di una lesione chirurgica. I più importanti sono:</p>
                                 <ul class="list-disc list-inside space-y-1 mt-2">
                                    <li><strong>Dolore:</strong> Severo, refrattario o che risponde solo temporaneamente agli analgesici.</li>
                                    <li><strong>Frequenza Cardiaca:</strong> Persistentemente elevata (> 60 bpm) nonostante la terapia analgesica.</li>
                                    <li><strong>Reflusso Naso-gastrico:</strong> La presenza di reflusso abbondante (> 2-3 litri) è un forte indicatore di ostruzione intestinale.</li>
                                    <li><strong>Esplorazione Rettale:</strong> Rilievo di anse intestinali distese, edematose o dislocate.</li>
                                    <li><strong>Liquido Peritoneale:</strong> Alterazioni di colore (da giallo a siero-emorragico/emorragico) e aumento di proteine e cellule indicano un danno alla parete intestinale.</li>
                                    <li><strong>Parametri sistemici:</strong> Segni di shock endotossico come mucose congeste, TRC prolungato, estremità fredde.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-600">L'Importanza del Tempo</h3>
                                <p class="text-gray-700">Nelle coliche chirurgiche, il tempo è il fattore prognostico più critico. Un referral tempestivo aumenta drasticamente le possibilità di sopravvivenza e riduce le complicazioni post-operatorie. Il ruolo del veterinario in campo è stabilizzare il paziente e riconoscere il più rapidamente possibile la necessità di un intervento chirurgico.</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- English -->
                <div lang="en" class="hidden">
                    <h2 class="text-center text-3xl font-bold text-green-600 mb-6">Decision Made!</h2>
                    <p class="text-center text-xl mb-4">Action required: <strong>Immediate referral to a surgical facility</strong></p>
                    <div id="printable-summary-en">
                        <h2 class="text-center text-2xl font-bold text-gray-800 mb-4 mt-6">Summary Sheet: Surgical Colic in Horses</h2>
                        <div class="space-y-4 text-left">
                            <!-- Contenuto EN... -->
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-600">What is it?</h3>
                                <p class="text-gray-700">Colic is a general term for abdominal pain. The most important distinction is between "medical" colic (manageable in the field with medication) and "surgical" colic, caused by lesions such as torsions (volvulus), strangulations, or displacements that require surgery to resolve.</p>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-600">Indicators for Surgery</h3>
                                <p class="text-gray-700">The decision to refer a horse to a clinic is based on a combination of factors. No single parameter is definitive, but the presence of multiple indicators increases the likelihood of a surgical lesion. The most important are:</p>
                                <ul class="list-disc list-inside space-y-1 mt-2">
                                    <li><strong>Pain:</strong> Severe, refractory, or only temporarily responsive to analgesics.</li>
                                    <li><strong>Heart Rate:</strong> Persistently high (> 60 bpm) despite analgesic therapy.</li>
                                    <li><strong>Nasogastric Reflux:</strong> The presence of significant reflux (> 2-3 liters) is a strong indicator of intestinal obstruction.</li>
                                    <li><strong>Rectal Examination:</strong> Findings of distended, edematous, or displaced intestinal loops.</li>
                                    <li><strong>Peritoneal Fluid:</strong> Changes in color (from yellow to serosanguineous/hemorrhagic) and increased protein and cell counts indicate damage to the intestinal wall.</li>
                                    <li><strong>Systemic Parameters:</strong> Signs of endotoxic shock such as congested mucous membranes, prolonged CRT, and cold extremities.</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-600">The Importance of Time</h3>
                                <p class="text-gray-700">In surgical colic, time is the most critical prognostic factor. A timely referral dramatically increases the chances of survival and reduces post-operative complications. The field veterinarian's role is to stabilize the patient and recognize the need for surgery as quickly as possible.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-8">
                    <button id="print-btn" onclick="printSummary()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300" data-translate-key="printButton">Stampa o Salva Riassunto</button>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p data-translate-key="footerCredit">Creato da Sara Busechian.</p>
            <p data-translate-key="footerText" class="mt-1">Questo caso clinico è stato generato a scopo didattico.</p>
        </footer>
    </div>

<script>
let currentLanguage = 'it';

const translations = {
    it: {
        mainTitle: "Caso Clinico Veterinario Interattivo",
        mainSubtitle: "Risolvi il caso passo dopo passo",
        readingSettings: "Impostazioni di lettura:",
        fontStandard: "Font Standard",
        fontAccessible: "Font Accessibile",
        language: "Lingua:",
        anamnesisTitle: "1. Anamnesi e Segnalamento",
        anamnesisContent: `<p><strong>Paziente:</strong> Cavallo maschio castrone, Sella Italiano, 12 anni.</p><p><strong>Storia recente:</strong> Il proprietario chiama alle 22:00. Riferisce che il cavallo è in colica da circa un'ora. Mostra dolore acuto: si guarda i fianchi, raspa con gli anteriori e tenta di coricarsi.</p><p><strong>Gestione:</strong> Il cavallo vive in box e viene allenato due volte a settimana per salto ostacoli. L'alimentazione non è cambiata di recente.</p><p><strong>Profilassi:</strong> Il proprietario riferisce che il cavallo è regolarmente vaccinato e sottoposto a trattamento per endoparassiti.</p>`,
        clinicalExamTitle: "2. Esame Clinico",
        clinicalExamContent: `<p>All'arrivo, il cavallo è sudato e ansioso. I parametri clinici sono i seguenti:</p><ul class="list-disc list-inside space-y-1"><li><strong>Frequenza Cardiaca (FC):</strong> 80 battiti al minuto (bpm).</li><li><strong>Frequenza Respiratoria (FR):</strong> 40 atti al minuto (apm).</li><li><strong>Temperatura Rettale:</strong> 38.2°C.</li><li><strong>Mucose apparenti:</strong> Congeste, con un alone violaceo sul margine gengivale (toxic line). Tempo di Riempimento Capillare (TRC) > 3 secondi.</li><li><strong>Motilità intestinale:</strong> Assente su tutti e quattro i quadranti.</li></ul>`,
        diagnosticProcTitle: "3. Procedure Diagnostiche Iniziali",
        diagnosticProcContent: `<p>Dato il quadro clinico grave, si procede immediatamente con le manovre diagnostiche e terapeutiche di base.</p><ul class="list-disc list-inside space-y-1"><li><strong>Sondaggio naso-gastrico:</strong> Si ottiene un reflusso spontaneo di 10 litri di liquido maleodorante e di colore rossastro.</li><li><strong>Esplorazione rettale:</strong> Si apprezzano anse di piccolo intestino notevolmente distese e edematose ("a salsicciotto") nel quadrante addominale destro.</li><li><strong>Analgesia:</strong> Si somministra Flunixin Meglumine per via endovenosa. Il dolore si attenua solo parzialmente e per breve tempo.</li></ul>`,
        abdominocentesisTitle: "4. Paracentesi Addominale",
        abdominocentesisContent: `<p>Si esegue un prelievo di liquido peritoneale (abdominocentesi).</p><p><strong>Risultato:</strong> Il liquido appare torbido e di colore siero-emorragico (rosa-arancio). Le proteine totali sono elevate (4.5 g/dL) e la conta dei leucociti è aumentata.</p>`,
        quizCompleted: "Quiz Completato!",
        yourScoreIs: "Il tuo punteggio è:",
        scoreText: "Di seguito trovi il riepilogo delle tue risposte e la scheda del caso clinico.",
        reviewTitle: "Riepilogo Risposte",
        yourAnswer: "La tua risposta:",
        correctAnswer: "Risposta corretta:",
        noAnswer: "Nessuna risposta",
        printButton: "Stampa o Salva Riassunto",
        footerCredit: "Creato da Sara Busechian.",
        footerText: "Questo caso clinico è stato generato a scopo didattico.",
        questionProgress: "Domanda",
        of: "di",
        printWindowTitle: "Riassunto Caso Clinico"
    },
    en: {
        mainTitle: "Interactive Veterinary Clinical Case",
        mainSubtitle: "Solve the case step-by-step",
        readingSettings: "Reading Settings:",
        fontStandard: "Standard Font",
        fontAccessible: "Accessible Font",
        language: "Language:",
        anamnesisTitle: "1. Signalment and History",
        anamnesisContent: `<p><strong>Patient:</strong> 12-year-old Sella Italiano gelding.</p><p><strong>Recent History:</strong> The owner calls at 10:00 PM. They report the horse has been showing signs of colic for about an hour. It displays acute pain: flank-watching, pawing, and attempting to lie down.</p><p><strong>Management:</strong> The horse is stabled and is trained for show jumping twice a week. The diet has not changed recently.</p><p><strong>Prophylaxis:</strong> The owner reports the horse is regularly vaccinated and treated for endoparasites.</p>`,
        clinicalExamTitle: "2. Clinical Examination",
        clinicalExamContent: `<p>Upon arrival, the horse is sweaty and anxious. The clinical parameters are as follows:</p><ul class="list-disc list-inside space-y-1"><li><strong>Heart Rate (HR):</strong> 80 beats per minute (bpm).</li><li><strong>Respiratory Rate (RR):</strong> 40 breaths per minute (bpm).</li><li><strong>Rectal Temperature:</strong> 38.2°C.</li><li><strong>Mucous Membranes:</strong> Congested, with a purple hue along the gum line (toxic line). Capillary Refill Time (CRT) > 3 seconds.</li><li><strong>Gut Motility:</strong> Absent in all four quadrants.</li></ul>`,
        diagnosticProcTitle: "3. Initial Diagnostic Procedures",
        diagnosticProcContent: `<p>Given the severe clinical picture, basic diagnostic and therapeutic procedures are performed immediately.</p><ul class="list-disc list-inside space-y-1"><li><strong>Nasogastric intubation:</strong> 10 liters of foul-smelling, reddish fluid are obtained as spontaneous reflux.</li><li><strong>Rectal examination:</strong> Markedly distended and edematous small intestinal loops ("sausage-like") are palpated in the right abdominal quadrant.</li><li><strong>Analgesia:</strong> Flunixin meglumine is administered intravenously. The pain is only partially and briefly relieved.</li></ul>`,
        abdominocentesisTitle: "4. Abdominocentesis",
        abdominocentesisContent: `<p>A sample of peritoneal fluid is collected (abdominocentesis).</p><p><strong>Result:</strong> The fluid appears cloudy and serosanguineous (pink-orange). Total protein is elevated (4.5 g/dL), and the white blood cell count is increased.</p>`,
        quizCompleted: "Quiz Completed!",
        yourScoreIs: "Your score is:",
        scoreText: "Below you will find a summary of your answers and the case study sheet.",
        reviewTitle: "Answers Summary",
        yourAnswer: "Your answer:",
        correctAnswer: "Correct answer:",
        noAnswer: "No answer",
        printButton: "Print or Save Summary",
        footerCredit: "Created by Sara Busechian.",
        footerText: "This clinical case was generated for educational purposes.",
        questionProgress: "Question",
        of: "of",
        printWindowTitle: "Clinical Case Summary"
    }
};

const quizData = [
    { 
        question: { it: "Di fronte a un cavallo con dolore acuto, qual è il parametro clinico più importante da valutare per stimare la gravità della situazione?", en: "When faced with a horse in acute pain, what is the most important clinical parameter to assess the severity of the situation?" }, 
        answer: 1, 
        reveals: "visita-clinica", 
        options: { 
            it: ["A. La temperatura rettale", "B. La frequenza cardiaca", "C. La frequenza respiratoria", "D. Il colore delle mucose"],
            en: ["A. Rectal temperature", "B. Heart rate", "C. Respiratory rate", "D. Mucous membrane color"]
        }
    },
    { 
        question: { it: "Una FC di 80 bpm e una 'toxic line' sulle gengive indicano:", en: "A heart rate of 80 bpm and a 'toxic line' on the gums indicate:" }, 
        answer: 2, 
        reveals: null, 
        options: {
            it: ["A. Un dolore lieve e gestibile in campo", "B. Uno stato di disidratazione moderata", "C. Un grave stato di shock endotossico, spesso associato a una lesione intestinale con compromissione vascolare", "D. Un'infezione batterica sistemica"],
            en: ["A. Mild pain manageable in the field", "B. A state of moderate dehydration", "C. Severe endotoxic shock, often associated with an intestinal lesion with vascular compromise", "D. A systemic bacterial infection"]
        }
    },
    { 
        question: { it: "Qual è la procedura diagnostico/terapeutica più urgente da eseguire in un cavallo con colica grave e FC elevata?", en: "What is the most urgent diagnostic/therapeutic procedure to perform in a horse with severe colic and a high heart rate?" }, 
        answer: 2, 
        reveals: "iter-diagnostico", 
        options: {
            it: ["A. Un prelievo di sangue", "B. Un'ecografia addominale", "C. Il sondaggio naso-gastrico", "D. La somministrazione di un lassativo"],
            en: ["A. A blood draw", "B. An abdominal ultrasound", "C. Nasogastric intubation", "D. Administration of a laxative"]
        }
    },
    { 
        question: { it: "La presenza di 10 litri di reflusso naso-gastrico indica con alta probabilità:", en: "The presence of 10 liters of nasogastric reflux most likely indicates:" }, 
        answer: 1, 
        reveals: null, 
        options: {
            it: ["A. Un'ulcera gastrica", "B. Un'ostruzione del piccolo intestino (meccanica o funzionale)", "C. Un'eccessiva assunzione di acqua", "D. Un'ostruzione del grosso intestino"],
            en: ["A. A gastric ulcer", "B. A small intestinal obstruction (mechanical or functional)", "C. Excessive water intake", "D. A large intestinal obstruction"]
        }
    },
    { 
        question: { it: "Il rilievo all'esplorazione rettale di anse del piccolo intestino distese e edematose è compatibile con quale diagnosi?", en: "The finding of distended and edematous small intestinal loops on rectal examination is compatible with which diagnosis?" }, 
        answer: 2, 
        reveals: "risultati-test", 
        options: {
            it: ["A. Spostamento dorsale sinistro del colon", "B. Costipazione del grosso colon", "C. Volvolo o strangolamento del piccolo intestino", "D. Enterite"],
            en: ["A. Left dorsal displacement of the colon", "B. Large colon impaction", "C. Small intestinal volvulus or strangulation", "D. Enteritis"]
        }
    },
    { 
        question: { it: "Un liquido peritoneale torbido e siero-emorragico cosa suggerisce?", en: "What does cloudy and serosanguineous peritoneal fluid suggest?" }, 
        answer: 2, 
        reveals: null, 
        options: {
            it: ["A. Una peritonite batterica primaria", "B. Un trauma addominale recente", "C. Una sofferenza della parete intestinale (ischemia/necrosi) con passaggio di liquidi, proteine e globuli rossi in addome", "D. Una normale risposta infiammatoria a una colica medica"],
            en: ["A. Primary bacterial peritonitis", "B. Recent abdominal trauma", "C. Compromise of the intestinal wall (ischemia/necrosis) with leakage of fluid, protein, and red blood cells into the abdomen", "D. A normal inflammatory response to medical colic"]
        }
    },
    { 
        question: { it: "Il cavallo risponde solo parzialmente e per breve tempo all'analgesico. Questo significa che:", en: "The horse responds only partially and briefly to the analgesic. This means that:" }, 
        answer: 1, 
        reveals: null, 
        options: {
            it: ["A. Il farmaco non è efficace e bisogna cambiarlo", "B. Il dolore è di tipo 'meccanico' (dovuto a tensione e ischemia) e non solo infiammatorio, quindi non può essere controllato completamente dai FANS", "C. La dose di farmaco era insufficiente", "D. Il cavallo sta sviluppando una resistenza al farmaco"],
            en: ["A. The drug is ineffective and should be changed", "B. The pain is 'mechanical' (due to tension and ischemia) and not just inflammatory, so it cannot be fully controlled by NSAIDs", "C. The drug dose was insufficient", "D. The horse is developing resistance to the drug"]
        }
    },
     { 
        question: { it: "Quale dei seguenti quadri NON è tipicamente considerato un'emergenza chirurgica?", en: "Which of the following conditions is NOT typically considered a surgical emergency?" }, 
        answer: 1, 
        reveals: null, 
        options: {
            it: ["A. Volvolo del grosso colon", "B. Dislocazione dorsale sinistra del colon (incarceramento nello spazio nefrosplenico)", "C. Strangolamento dell'intestino tenue da lipoma peduncolato", "D. Ernia nel forame epiploico"],
            en: ["A. Large colon volvulus", "B. Left dorsal displacement of the colon (nephrosplenic entrapment)", "C. Small intestinal strangulation by a pedunculated lipoma", "D. Epiploic foramen entrapment"]
        }
    },
    { 
        question: { it: "Mettendo insieme tutti i dati (FC 80, reflusso, reperti rettali, liquido peritoneale, dolore refrattario), qual è l'unica decisione corretta?", en: "Putting all the data together (HR 80, reflux, rectal findings, peritoneal fluid, refractory pain), what is the only correct decision?" }, 
        answer: 3, 
        reveals: null, 
        options: {
            it: ["A. Tentare con un secondo bolo di analgesico e rivalutare tra un'ora", "B. Sondare di nuovo il cavallo e idratarlo con fluidi per via orale", "C. Lasciare il cavallo libero in un paddock per vedere se si risolve da solo", "D. Stabilizzare il cavallo e organizzare il trasporto immediato verso una clinica chirurgica"],
            en: ["A. Try a second dose of analgesic and re-evaluate in an hour", "B. Pass the nasogastric tube again and hydrate with oral fluids", "C. Turn the horse out in a paddock to see if it resolves on its own", "D. Stabilize the horse and arrange for immediate transport to a surgical facility"]
        }
    },
    { 
        question: { it: "Qual è il fattore più importante che influenza la prognosi di un cavallo con colica chirurgica?", en: "What is the most important factor influencing the prognosis for a horse with surgical colic?" }, 
        answer: 2, 
        reveals: "final-summary", 
        options: {
            it: ["A. L'età del cavallo", "B. La razza del cavallo", "C. Il tempo che intercorre tra l'insorgenza dei sintomi e l'intervento chirurgico", "D. Il tipo di anestesia utilizzata"],
            en: ["A. The age of the horse", "B. The breed of the horse", "C. The time elapsed between the onset of symptoms and surgery", "D. The type of anesthesia used"]
        }
    }
];

let currentQuestionIndex = 0;
const quizContainer = document.getElementById('quiz-container');
let userAnswers = new Array(quizData.length).fill(null);

// --- Accessibility & Language Functions ---
const standardFontBtn = document.getElementById('font-standard-btn');
const dyslexicFontBtn = document.getElementById('font-dyslexic-btn');
const langItBtn = document.getElementById('lang-it-btn');
const langEnBtn = document.getElementById('lang-en-btn');
const body = document.body;

function setFont(fontType) {
    if (fontType === 'dyslexic') {
        body.classList.add('font-dyslexic');
        standardFontBtn.classList.remove('active');
        dyslexicFontBtn.classList.add('active');
        localStorage.setItem('fontPreference', 'dyslexic');
    } else {
        body.classList.remove('font-dyslexic');
        dyslexicFontBtn.classList.remove('active');
        standardFontBtn.classList.add('active');
        localStorage.setItem('fontPreference', 'standard');
    }
}

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('languagePreference', lang);

    if (lang === 'en') {
        langItBtn.classList.remove('active');
        langEnBtn.classList.add('active');
    } else {
        langEnBtn.classList.remove('active');
        langItBtn.classList.add('active');
    }
    
    document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.dataset.translateKey;
        if (translations[lang][key]) {
            // Use innerHTML for keys that contain HTML tags
            if (key.includes('Content')) {
                 el.innerHTML = translations[lang][key];
            } else {
                 el.innerText = translations[lang][key];
            }
        }
    });

    updateDynamicContent();
}

function updateDynamicContent() {
    if (currentQuestionIndex < quizData.length && !document.getElementById('results-section').style.display || document.getElementById('results-section').style.display === 'none') {
        displayQuestion();
    } else {
        showResults();
    }
}

standardFontBtn.addEventListener('click', () => setFont('standard'));
dyslexicFontBtn.addEventListener('click', () => setFont('dyslexic'));
langItBtn.addEventListener('click', () => setLanguage('it'));
langEnBtn.addEventListener('click', () => setLanguage('en'));

document.addEventListener('DOMContentLoaded', () => {
    const savedFont = localStorage.getItem('fontPreference') || 'standard';
    const savedLang = localStorage.getItem('languagePreference') || 'it';
    setFont(savedFont);
    setLanguage(savedLang);
    displayQuestion(); // Initial display
});

// Text-to-Speech
document.getElementById('case-container').addEventListener('click', function(event) {
    const ttsButton = event.target.closest('.tts-button');
    if (ttsButton) {
        const sectionToRead = ttsButton.parentElement;
        const title = sectionToRead.querySelector('h2, h3');
        const content = Array.from(sectionToRead.children).filter(el => !el.matches('button, h2, h3')).map(el => el.innerText).join('\n');
        const textToRead = (title ? title.innerText + '.\n' : '') + content;
        
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
            document.querySelectorAll('.tts-button').forEach(btn => btn.classList.remove('active'));
        } else {
            const utterance = new SpeechSynthesisUtterance(textToRead);
            utterance.lang = currentLanguage === 'en' ? 'en-US' : 'it-IT';
            utterance.onend = () => {
                ttsButton.classList.remove('active');
            };
            speechSynthesis.speak(utterance);
            ttsButton.classList.add('active');
        }
    }
});

// --- Quiz Logic ---
function displayQuestion() {
    if (currentQuestionIndex >= quizData.length) {
        if (!document.getElementById('results-section').style.display || document.getElementById('results-section').style.display === 'none') {
             showResults();
        }
        return;
    }
    const currentQuiz = quizData[currentQuestionIndex];
    let optionsHtml = '';
    currentQuiz.options[currentLanguage].forEach((option, index) => {
        optionsHtml += `<button class="quiz-option" data-index="${index}">${option}</button>`;
    });

    const progressIndicator = `<p class="text-center text-gray-600 font-semibold mb-2">${translations[currentLanguage].questionProgress} ${currentQuestionIndex + 1} ${translations[currentLanguage].of} ${quizData.length}</p>`;

    quizContainer.innerHTML = `
        <div class="mb-4">
            ${progressIndicator}
            <div class="quiz-card p-4 border rounded-lg">
                <button class="tts-button" aria-label="Leggi ad alta voce">
                    <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                <h3 class="text-lg font-semibold mb-4">${currentQuiz.question[currentLanguage]}</h3>
                <div class="options-container">${optionsHtml}</div>
            </div>
        </div>
    `;
    document.querySelectorAll('.quiz-option').forEach(button => {
        button.addEventListener('click', checkAnswer);
    });
}

function checkAnswer(event) {
    const selectedOption = event.target.closest('.quiz-option'); 
    if (!selectedOption || selectedOption.disabled) return;
    speechSynthesis.cancel();
    const selectedAnswerIndex = parseInt(selectedOption.dataset.index);
    userAnswers[currentQuestionIndex] = selectedAnswerIndex;
    document.querySelectorAll('.quiz-option').forEach(btn => btn.disabled = true);
    selectedOption.classList.add('selected');
    const currentQuiz = quizData[currentQuestionIndex];
    setTimeout(() => {
        if (currentQuiz.reveals) {
            const revealedSection = document.getElementById(currentQuiz.reveals);
            if(revealedSection) {
                revealedSection.style.display = 'block';
                revealedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        currentQuestionIndex++;
        displayQuestion();
    }, 500);
}

function showResults() {
    quizContainer.innerHTML = ''; 
    let score = 0;
    let reviewHtml = `<h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">${translations[currentLanguage].reviewTitle}</h2>`;
    quizData.forEach((question, index) => {
        const userAnswerIndex = userAnswers[index];
        const correctAnswerIndex = question.answer;
        const userAnswerText = userAnswerIndex !== null ? question.options[currentLanguage][userAnswerIndex] : translations[currentLanguage].noAnswer;
        const correctAnswerText = question.options[currentLanguage][correctAnswerIndex];
        const isCorrect = userAnswerIndex === correctAnswerIndex;
        if (isCorrect) score++;
        reviewHtml += `
            <div class="p-4 mb-4 border-l-4 rounded-r-lg ${isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}">
                <p class="font-semibold text-gray-800">${index + 1}. ${question.question[currentLanguage]}</p>
                <p class="mt-2 text-md ${isCorrect ? 'text-green-800' : 'text-red-800'}">
                    <strong>${translations[currentLanguage].yourAnswer}</strong> ${userAnswerText} ${isCorrect ? '<span class="text-green-600 font-bold">&#10004;</span>' : '<span class="text-red-600 font-bold">&#10008;</span>'}
                </p>
                ${!isCorrect ? `<p class="mt-1 text-md text-gray-700"><strong>${translations[currentLanguage].correctAnswer}</strong> ${correctAnswerText}</p>` : ''}
            </div>`;
    });
    const resultsSection = document.getElementById('results-section');
    resultsSection.innerHTML = `
        <h2 class="text-center text-3xl font-bold text-indigo-600 mb-4">${translations[currentLanguage].quizCompleted}</h2>
        <p class="text-center text-xl text-gray-800">${translations[currentLanguage].yourScoreIs} <strong class="text-2xl">${score} / ${quizData.length}</strong></p>
        <p class="text-center text-gray-600 mt-4">${translations[currentLanguage].scoreText}</p>`;
    resultsSection.style.display = 'block';
    if(currentQuestionIndex === quizData.length) resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    document.getElementById('review-section').innerHTML = reviewHtml;
    document.getElementById('review-section').style.display = 'block';
    
    document.querySelectorAll('#final-summary > div').forEach(el => el.classList.add('hidden'));
    document.querySelector(`#final-summary > div[lang=${currentLanguage}]`).classList.remove('hidden');
    document.getElementById('final-summary').style.display = 'block';
}

function printSummary() {
    const printableContent = document.getElementById(`printable-summary-${currentLanguage}`).innerHTML;
    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write(`<html><head><title>${translations[currentLanguage].printWindowTitle}</title>`);
    printWindow.document.write(`<style>body{font-family:'Inter',sans-serif;line-height:1.6;color:#374151;padding:2rem}h2{text-align:center;font-size:1.5rem;font-weight:bold;color:#111827;margin-bottom:1rem}h3{font-size:1.125rem;font-weight:600;color:#4f46e5;border-bottom:1px solid #e5e7eb;padding-bottom:0.25rem;margin-top:1.5rem}ul{list-style-type:disc;list-style-position:inside;padding-left:1rem}li{margin-bottom:0.25rem}strong{font-weight:600;color:#1f2937}</style><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">`);
    printWindow.document.write('</head><body>');
    printWindow.document.write(printableContent);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
}

</script>

</body>
</html>
